# 开发环境 Docker Compose
# 默认全容器运行，支持通过环境变量配置前后端地址
#
# 配置方式：修改 .env.dev 文件
#   FRONTEND_UPSTREAM: frontend:4010 (容器) 或 host.docker.internal:4010 (本地)
#   BACKEND_UPSTREAM: backend:8020 (容器) 或 host.docker.internal:8020 (本地)
#
# 使用方法:
#   1. 生成 HTTPS 证书（首次）：./generate-cert.sh
#   2. 启动服务：docker compose -f docker-compose.dev.yml up -d
#   3. 访问：https://localhost:8021

services:
  # ============================================
  # Nginx 反向代理
  # ============================================
  nginx:
    image: m.daocloud.io/docker.io/nginx:alpine
    container_name: chewybbtalk-nginx-dev
    ports:
      - "${PORT:-8021}:80"
    volumes:
      - ./nginx.dev.conf.tmpl:/etc/nginx/nginx.conf.tmpl:ro
    env_file: .env.dev
    environment:
      - FRONTEND_UPSTREAM=${FRONTEND_UPSTREAM:-frontend:4010}
      - BACKEND_UPSTREAM=${BACKEND_UPSTREAM:-backend:8020}
      - PORT=${PORT:-8021}
    command: >
      sh -c '
        export FRONTEND_UPSTREAM BACKEND_UPSTREAM PORT;
        echo "Frontend: $$FRONTEND_UPSTREAM";
        echo "Backend: $$BACKEND_UPSTREAM";
        envsubst "\$$FRONTEND_UPSTREAM \$$BACKEND_UPSTREAM \$$PORT" < /etc/nginx/nginx.conf.tmpl > /etc/nginx/nginx.conf &&
        nginx -g "daemon off;"
      '
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - frontend
      - backend

  # ============================================
  # 前端服务
  # ============================================
  frontend:
    image: m.daocloud.io/docker.io/node:20-alpine
    container_name: chewybbtalk-frontend-dev
    working_dir: /app
    volumes:
      - ./frontend:/app:rw
    environment:
      - VITE_API_BASE_URL=
      - VITE_MEDIA_URL_PROTOCOL=https
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 4010"
    expose:
      - "4010"

  # ============================================
  # 后端服务
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: chewybbtalk-backend-dev
    volumes:
      - ./backend/chewy_space:/app/chewy_space:rw
      - ./data:/data:rw
    env_file: .env.dev
    environment:
      - CHEWYBBTALK_SETTINGS_MODULE=configs.dev_settings
      - ENV=dev
      - DEBUG=True
      - CORS_ORIGIN_ALLOW_ALL=${CORS_ORIGIN_ALLOW_ALL:-True}
      - ALLOWED_HOSTS=*
    command: sh -c "mkdir -p /data/dev/media/attachments && cd /app/chewy_space && uv run python manage.py migrate && uv run python manage.py runserver 0.0.0.0:8020"
    expose:
      - "8020"
